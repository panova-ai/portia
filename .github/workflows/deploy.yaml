name: Deploy

on:
  push:
    branches:
      - main
      - 'dev-*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  REGION: us-central1
  SERVICE_NAME: portia
  WIF_PROVIDER: projects/766608563176/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  WIF_SERVICE_ACCOUNT: github-actions@panova-461721.iam.gserviceaccount.com

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      project_id: ${{ steps.set-env.outputs.project_id }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="staging"
          elif [[ "${{ github.ref }}" == refs/heads/dev-* ]]; then
            ENV="dev"
          else
            ENV="dev"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          case $ENV in
            dev)
              echo "project_id=panova-dev" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "project_id=panova-staging" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "project_id=panova-prod" >> $GITHUB_OUTPUT
              ;;
          esac

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "2.1.1"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction

      - name: Run tests
        run: poetry run pytest -v

  build-and-push:
    needs: [determine-environment, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      contents: read
      id-token: write

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        id: build
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ needs.determine-environment.outputs.project_id }}/portia/portia:${{ github.sha }}"
          docker build -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  deploy-portia:
    needs: [determine-environment, build-and-push]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          project_id: ${{ needs.determine-environment.outputs.project_id }}
          image: ${{ needs.build-and-push.outputs.image }}
          env_vars: |
            GCP_PROJECT_ID=${{ needs.determine-environment.outputs.project_id }}
            GCP_REGION=${{ env.REGION }}
            MS_CONVERTER_URL=https://ms-fhir-converter-${{ needs.determine-environment.outputs.project_id }}.run.app
            TEMP_BUCKET=${{ needs.determine-environment.outputs.project_id }}-portia-temp
            EXPORTS_BUCKET=${{ needs.determine-environment.outputs.project_id }}-portia-exports

  deploy-ms-converter:
    needs: [determine-environment, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}
    permissions:
      contents: read
      id-token: write
    # Only deploy MS converter on first deployment or manual trigger
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Copy MS FHIR Converter image to Artifact Registry
        run: |
          # Pull from Microsoft Container Registry
          docker pull mcr.microsoft.com/healthcareapis/fhir-converter:1.0.367-preview
          # Tag for our Artifact Registry
          docker tag mcr.microsoft.com/healthcareapis/fhir-converter:1.0.367-preview \
            ${{ env.REGION }}-docker.pkg.dev/${{ needs.determine-environment.outputs.project_id }}/portia/ms-fhir-converter:latest
          # Push to Artifact Registry
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ needs.determine-environment.outputs.project_id }}/portia/ms-fhir-converter:latest

      - name: Deploy MS FHIR Converter to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ms-fhir-converter
          region: ${{ env.REGION }}
          project_id: ${{ needs.determine-environment.outputs.project_id }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ needs.determine-environment.outputs.project_id }}/portia/ms-fhir-converter:latest
          flags: |
            --memory=2Gi
            --cpu=2
            --ingress=internal
            --no-allow-unauthenticated
